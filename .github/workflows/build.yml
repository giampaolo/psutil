name: macos-asan-arm64
on:
  push:
  pull_request:

jobs:
  build:
    runs-on: macos-14 # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          brew install python@3.11
          python3 -m pip install --upgrade --break-system-packages pip setuptools wheel pytest

      - name: Build psutil with ASan
        env:
          CFLAGS: "-fsanitize=address -g -O1 -fno-omit-frame-pointer"
          LDFLAGS: "-fsanitize=address"
        run: |
          python3 setup.py build_ext --inplace

      - name: Build ASan wrapper
        run: |
          cat > run_with_asan.c <<'EOF'
          #include <unistd.h>
          #include <stdlib.h>
          #include <stdio.h>

          int main(int argc, char** argv) {
              if (argc < 3) {
                  fprintf(stderr, "Usage: run_with_asan <asan_path> <python args...>\n");
                  return 1;
              }
              setenv("DYLD_INSERT_LIBRARIES", argv[1], 1);
              execvp(argv[2], &argv[2]);
              perror("execvp");
              return 1;
          }
          EOF
          clang -arch arm64 run_with_asan.c -o run_with_asan

      - name: Run tests with ASan
        run: |
          ASAN_RT=$(clang -print-file-name=libclang_rt.asan_osx_dynamic.dylib)
          PYBIN=$(which python3)
          echo "Using ASan runtime: $ASAN_RT"
          echo "Python binary: $PYBIN"

          # Make sure Python is the Homebrew one (unsigned)
          codesign -dv --verbose=4 "$PYBIN" || true

          ./run_with_asan "$ASAN_RT" "$PYBIN" -c "import psutil; print('ASan OK')"
          ./run_with_asan "$ASAN_RT" "$PYBIN" -m pytest -q psutil/tests --disable-warnings --maxfail=1
