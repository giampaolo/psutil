name: macOS ASan build

on:
  push:
  pull_request:

jobs:
  asan-test:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel pytest

      - name: Build psutil with ASan
        run: |
          export CFLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer"
          export LDFLAGS="-fsanitize=address"
          export MACOSX_DEPLOYMENT_TARGET=10.10

          echo "Building psutil with ASan..."
          python setup.py build_ext --inplace

          echo "Listing built shared objects:"
          find psutil -name "*.so" -ls

      - name: Locate ASan runtime
        id: asan
        run: |
          ASAN_PATH=$(clang -print-file-name=libclang_rt.asan_osx_dynamic.dylib)
          echo "ASAN_PATH=$ASAN_PATH" >> $GITHUB_ENV
          echo "Found ASan runtime: $ASAN_PATH"

      - name: Run psutil tests under ASan
        env:
          DYLD_INSERT_LIBRARIES: ${{ env.ASAN_PATH }}
        run: |
          echo "Preloading ASan runtime: $DYLD_INSERT_LIBRARIES"
          python -c "import psutil; print('ASan preloaded OK')"
          python -m pytest -q psutil/tests --maxfail=1 --disable-warnings

      - name: Show ASan log if crash occurred
        if: failure()
        run: |
          echo "Dumping recent crash logs..."
          ls -lt /Library/Logs/DiagnosticReports | head -n 10 || true
